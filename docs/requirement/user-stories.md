# 用户故事 (User Stories)

本文档从实际使用场景出发，描述不同角色用户的需求和期望。每个故事包含角色、目标、动机和验收标准。

---

## 角色定义

- **终端用户（End User）**：通过消息平台与Agent交互的个人
- **开发者（Developer）**：集成PonyBunny到应用或编写自定义工具的工程师
- **管理员（Admin）**：负责部署、配置和维护系统的运维人员
- **安全审计员（Auditor）**：检查系统合规性和安全性的专业人员

---

## Epic 1: 日常AI助手使用

### Story 1.1: 跨平台无缝对话

**作为** 终端用户  
**我想** 在WhatsApp开始的对话能在Telegram继续  
**以便** 我不受限于单一消息平台

**验收标准**：
- [ ] 在WhatsApp发送"帮我分析这份日志"后，Agent在Telegram的回复能正确引用之前的上下文
- [ ] Session ID在不同Channel间保持一致
- [ ] 切换平台后，对话历史完整可见

**技术关联**：多Channel集成、Session管理

---

### Story 1.2: 长期项目协作

**作为** 终端用户  
**我想** Agent能记住一个月前的架构讨论  
**以便** 我不需要重复解释背景

**验收标准**：
- [ ] 在1000+轮对话后，Agent仍能回忆起第10轮提到的技术选型
- [ ] 手动触发`/compact`后，关键决策点保留在压缩历史中
- [ ] 查询"我们当时为什么选择PostgreSQL"能得到正确答案（基于Vector Memory）

**技术关联**：Session Compaction、Vector Memory

---

### Story 1.3: 紧急任务中止

**作为** 终端用户  
**我想** 立即停止Agent正在执行的错误命令  
**以便** 避免数据损坏或资源浪费

**验收标准**：
- [ ] 发送`/stop`后1秒内，Agent停止调用新的工具
- [ ] 已启动的Docker容器被立即终止
- [ ] UI显示"任务已中止"状态，并展示已完成的步骤

**技术关联**：AbortController、任务中止机制

---

## Epic 2: 企业安全与合规

### Story 2.1: 审计所有AI操作

**作为** 安全审计员  
**我想** 查看过去90天内所有Agent的文件修改记录  
**以便** 满足SOC 2审计要求

**验收标准**：
- [ ] 导出的日志包含所有`write`和`edit`工具调用
- [ ] 每条记录包含：时间戳、用户ID、文件路径、修改前后内容哈希
- [ ] 日志格式兼容Splunk/ELK等分析工具

**技术关联**：审计日志、工具调用记录

---

### Story 2.2: 敏感数据不出境

**作为** 管理员  
**我想** 确保所有对话数据存储在本地服务器  
**以便** 符合GDPR数据本地化要求

**验收标准**：
- [ ] 所有Session文件存储在`~/.openclaw/sessions/`
- [ ] LLM API调用通过自建代理或本地模型（Ollama）
- [ ] 无任何数据上传到PonyBunny开发者的服务器

**技术关联**：Local-first架构、本地模型支持

---

### Story 2.3: 设备访问控制

**作为** 管理员  
**我想** 批准新iPhone接入前，Agent无法访问其相机  
**以便** 防止未授权设备泄露隐私

**验收标准**：
- [ ] 新设备连接时，管理员收到配对请求通知
- [ ] 未批准前，该设备的`camera.snap`调用返回"未授权"错误
- [ ] 批准后，该设备立即可用，无需重启

**技术关联**：设备配对、Pairing Token机制

---

## Epic 3: 开发者集成

### Story 3.1: 自定义代码审查工具

**作为** 开发者  
**我想** 编写一个工具，让Agent调用内部的代码质量检查API  
**以便** 自动审查Pull Request

**验收标准**：
- [ ] 在`extensions/code-review/`创建工具后，Agent自动加载
- [ ] 工具定义了JSON Schema，Agent能正确传递参数
- [ ] 工具返回的结果在Agent的回复中引用

**技术关联**：Plugin系统、自定义Tool注册

---

### Story 3.2: 集成CI/CD失败通知

**作为** 开发者  
**我想** 当CI失败时，自动触发Agent分析日志  
**以便** 快速定位问题

**验收标准**：
- [ ] GitHub Actions调用Webhook：`POST /webhook/ci-failed`
- [ ] Agent接收日志URL，自动下载并分析
- [ ] 分析结果发送到Slack频道，@相关开发者

**技术关联**：Webhook集成、Channel路由

---

### Story 3.3: 低成本运营Subagent

**作为** 开发者  
**我想** 主Agent用GPT-4处理复杂任务，Subagent用GPT-3.5处理简单任务  
**以便** 降低60%+ API成本

**验收标准**：
- [ ] 配置`agents.defaults.subagent.model: "gpt-3.5-turbo"`
- [ ] 主Agent生成的子任务使用GPT-3.5执行
- [ ] 每月Token消耗报告显示成本下降 > 50%

**技术关联**：混合模型策略

---

## Epic 4: 多设备协同

### Story 4.1: 远程拍照获取现场信息

**作为** 终端用户  
**我想** Agent调用办公室的iPad拍摄白板  
**以便** 远程参与头脑风暴

**验收标准**：
- [ ] 用户发送"拍摄会议室白板"
- [ ] Agent识别需求，调用已配对iPad的`camera.snap`
- [ ] 照片上传到对话，Agent能基于图像内容回答问题（需Vision模型）

**技术关联**：Node系统、跨设备工具调用

---

### Story 4.2: 定时任务触发设备操作

**作为** 终端用户  
**我想** 每天早上8点，Agent自动调用智能音箱播放新闻摘要  
**以便** 我起床时获取最新信息

**验收标准**：
- [ ] 配置Cron任务：`0 8 * * * agent run "播放今日新闻"`
- [ ] Agent调用已配对音箱的`audio.play`工具
- [ ] 失败时发送通知到我的手机

**技术关联**：Cron Lane、设备控制

---

## Epic 5: 高级AI能力

### Story 5.1: 多模型自动降级

**作为** 终端用户  
**我想** 当Claude Opus配额用尽时，自动切换到Haiku  
**以便** 不中断对话

**验收标准**：
- [ ] Opus返回429错误后，5秒内切换到Haiku
- [ ] 系统通知："已切换到Claude Haiku以保证服务连续性"
- [ ] 切换事件记录到日志

**技术关联**：Model Failover、Auth Profile轮换

---

### Story 5.2: 智能上下文压缩

**作为** 终端用户  
**我想** 在达到Token限制前，Agent自动压缩历史  
**以便** 我无需手动管理对话长度

**验收标准**：
- [ ] 对话达到模型窗口80%时，自动触发Compaction
- [ ] 压缩后的历史包含所有关键决策和TODO
- [ ] 用户无感知延迟（Compaction在后台执行）

**技术关联**：Auto-compaction、Multi-part Summarization

---

### Story 5.3: RAG增强代码理解

**作为** 终端用户  
**我想** Agent能分析整个代码库的架构  
**以便** 回答"认证流程是如何实现的"

**验收标准**：
- [ ] 用户首次询问代码问题时，Agent提示"正在索引代码库"
- [ ] 索引完成后，Agent基于Vector Search检索相关代码
- [ ] 答案引用具体文件路径和行号

**技术关联**：Memory Index、Hybrid RAG

---

## Epic 6: 运维与监控

### Story 6.1: 实时性能监控

**作为** 管理员  
**我想** 在Grafana看到Agent执行的P95延迟  
**以便** 及时发现性能退化

**验收标准**：
- [ ] 仪表盘显示：每分钟请求数、P50/P95/P99延迟、错误率
- [ ] 延迟突增时触发告警（Slack/PagerDuty）
- [ ] 指标保留30天，支持历史对比

**技术关联**：Prometheus集成、监控指标

---

### Story 6.2: 成本追踪与预算控制

**作为** 管理员  
**我想** 查看每个用户本月的LLM API消耗  
**以便** 控制成本并按用量计费

**验收标准**：
- [ ] 管理面板显示：每用户的输入/输出Token总数、估算成本
- [ ] 设置预算上限后，达到90%时发送预警
- [ ] 超出预算的用户请求被限流

**技术关联**：Token统计、费用估算

---

### Story 6.3: 一键备份与恢复

**作为** 管理员  
**我想** 每天自动备份所有Session数据  
**以便** 在灾难时能恢复到24小时内的状态

**验收标准**：
- [ ] 每日凌晨2点自动执行备份脚本
- [ ] 备份包含：Session文件、SQLite数据库、配置文件
- [ ] 恢复测试成功（在测试环境验证）

**技术关联**：数据备份策略

---

## Epic 7: 用户体验优化

### Story 7.1: 流式输出即时反馈

**作为** 终端用户  
**我想** 看到Agent逐字输出回复  
**以便** 不需要等待完整响应

**验收标准**：
- [ ] Agent开始回复后，首个Token在2秒内显示
- [ ] 后续Token的间隔 < 100ms
- [ ] 网络抖动时，客户端能检测并提示"连接不稳定"

**技术关联**：WebSocket流式传输、Delta事件

---

### Story 7.2: 思考过程可视化

**作为** 终端用户  
**我想** 看到Agent的推理过程（Thinking Mode）  
**以便** 理解复杂决策的原因

**验收标准**：
- [ ] 开启Thinking Mode后，UI显示"Agent正在思考..."
- [ ] 思考内容折叠显示，点击展开查看详细推理步骤
- [ ] 最终答案与思考过程分开显示

**技术关联**：Thinking Level、UI设计

---

### Story 7.3: 移动端优化体验

**作为** 终端用户  
**我想** 在手机浏览器流畅使用Agent  
**以便** 随时随地访问

**验收标准**：
- [ ] Web UI响应式设计，在iPhone/Android正确显示
- [ ] 虚拟键盘不遮挡输入框
- [ ] 支持语音输入（通过浏览器API）

**技术关联**：前端UI优化

---

## Epic 8: 社区与生态

### Story 8.1: 分享自定义Tool

**作为** 开发者  
**我想** 将编写的工具发布到社区  
**以便** 其他用户受益

**验收标准**：
- [ ] 工具符合标准格式（`openclaw.plugin.json`）
- [ ] 提交到官方Plugin仓库（GitHub）
- [ ] 通过代码审查后，自动发布到NPM

**技术关联**：Plugin生态系统（未来）

---

### Story 8.2: 模板市场

**作为** 终端用户  
**我想** 从模板库安装"代码审查Agent"  
**以便** 快速配置常见场景

**验收标准**：
- [ ] 浏览模板市场，查看"代码审查"、"客服助手"等预设
- [ ] 一键安装后，Agent自动加载对应的System Prompt和工具
- [ ] 支持模板定制化（修改Prompt）

**技术关联**：配置模板系统（未来）

---

## Epic 9: 高级安全场景

### Story 9.1: 双因素认证设备配对

**作为** 管理员  
**我想** 配对设备时要求输入OTP验证码  
**以便** 防止物理设备被盗后非法接入

**验收标准**：
- [ ] 配对请求时，管理员手机收到OTP（通过TOTP）
- [ ] 输入正确OTP后，配对才生效
- [ ] OTP 30秒过期

**技术关联**：双因素认证集成（未来）

---

### Story 9.2: 敏感操作审批流程

**作为** 管理员  
**我想** Agent执行删除操作前，必须人工批准  
**以便** 防止误删重要数据

**验收标准**：
- [ ] Agent调用`delete_file`时，发送审批请求到管理员
- [ ] 管理员批准/拒绝后，Agent继续/中止执行
- [ ] 审批记录保存到审计日志

**技术关联**：人工审批流程（未来）

---

## 用户故事优先级

| Epic | P0（MVP） | P1（增强） | P2（高级） | P3（未来） |
|:-----|:---------|:----------|:----------|:----------|
| **日常AI助手** | 1.3（任务中止） | 1.1（跨平台）、1.2（长期记忆） | - | - |
| **企业安全** | 2.3（访问控制） | 2.1（审计）、2.2（数据本地化） | - | - |
| **开发者集成** | - | 3.1（自定义工具）、3.3（成本优化） | 3.2（Webhook） | - |
| **多设备协同** | - | - | 4.1（远程拍照） | 4.2（定时任务） |
| **高级AI** | 5.1（自动降级）、5.2（上下文压缩） | 5.3（RAG） | - | - |
| **运维监控** | - | 6.1（性能监控）、6.2（成本追踪） | 6.3（备份） | - |
| **用户体验** | 7.1（流式输出） | 7.2（思考可视化） | 7.3（移动端） | - |
| **社区生态** | - | - | - | 8.1（工具分享）、8.2（模板） |
| **高级安全** | - | - | - | 9.1（2FA）、9.2（审批流程） |
