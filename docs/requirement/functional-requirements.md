# 功能需求 (Functional Requirements)

## 1. 核心Agent能力

### 1.1 多模型支持与智能Failover

**需求描述**：系统必须支持多个LLM Provider，并在主模型失败时自动降级到备用模型。

**业务价值**：
- **避免单点依赖**：某个Provider宕机不影响业务连续性
- **成本优化**：根据任务复杂度选择性价比最优的模型
- **灵活性**：用户可以无缝切换模型供应商

**技术实现** (基于架构文档)：
- 三层Failover机制：
  1. 同Provider的Auth Profile轮换（处理quota限制）
  2. Fallback模型链（`agents.defaults.model.fallbacks`）
  3. Context Compaction后重试（处理上下文溢出）

**验收标准**：
- [ ] 配置2个以上fallback模型后，主模型429错误能在5秒内切换到备用模型
- [ ] 单次请求最多尝试所有fallback链，失败后才向用户报错
- [ ] 切换模型时，自动调整`thinkingLevel`参数（弱模型不支持高级推理）
- [ ] 切换过程记录在Session日志中，可追溯

**优先级**：P0（核心功能）

---

### 1.2 长上下文记忆维持

**需求描述**：Agent必须能够维持超过模型上下文窗口限制的长期对话，无需用户手动管理历史。

**业务价值**：
- **无缝体验**：用户不需要担心"遗忘"问题
- **复杂任务支持**：长期调试、架构讨论等场景不受限
- **数据完整性**：所有历史对话可检索，支持审计

**技术实现**：
- 双层记忆架构（Session History + Vector Memory）
- 自动Compaction触发：
  - Token达到80%阈值
  - API返回`context_length_exceeded`错误
  - 用户手动触发`/compact`命令
- Multi-Part Summarization算法，保留关键决策/TODO

**验收标准**：
- [ ] 单个Session支持1000+轮对话不丢失关键信息
- [ ] Compaction后，关键决策点、待办事项保留率 > 95%
- [ ] Compaction过程用户感知延迟 < 10秒
- [ ] 压缩后Token减少至原始的15%-40%（可配置）

**优先级**：P0（核心功能）

---

### 1.3 工具调用与沙箱执行

**需求描述**：Agent能够安全地调用外部工具（文件操作、命令执行、设备控制等），所有执行必须在隔离环境中进行。

**业务价值**：
- **安全性**：防止恶意/错误代码破坏宿主系统
- **可控性**：管理员可审查、限制工具权限
- **灵活性**：支持自定义工具扩展

**技术实现**：
- Docker沙箱隔离（只读根文件系统、Seccomp、AppArmor）
- 三层权限验证：
  1. 设备Ed25519签名认证
  2. Pairing Token授权
  3. 命令白名单过滤
- 幂等性保护（`idempotencyKey`防止重复执行）

**验收标准**：
- [ ] Agent无法修改Docker容器外的宿主系统文件
- [ ] 未配对设备的工具调用100%被拦截
- [ ] 不在白名单的命令调用返回明确错误信息
- [ ] 同一`idempotencyKey`的请求只执行一次，返回缓存结果

**优先级**：P0（安全核心）

---

## 2. 多Channel集成

### 2.1 统一消息抽象层

**需求描述**：系统必须提供统一的消息接口，屏蔽不同消息平台（WhatsApp、Telegram、Slack等）的协议差异。

**业务价值**：
- **开发效率**：新增Channel不需要修改Agent逻辑
- **一致性**：同一Agent行为在不同平台保持一致
- **可移植性**：用户可在不同平台间无缝切换

**技术实现**：
- `ChatEvent`标准化对象（定义在`src/config/sessions/types.ts`）
- Channel插件系统（`extensions/`目录）
- 标准化生命周期：Webhook接收 → 归一化 → 路由 → Agent处理 → 归一化响应 → Provider API发送

**验收标准**：
- [ ] 新增Channel只需实现`Plugin`接口，无需修改核心代码
- [ ] 同一Session在不同Channel间迁移不丢失上下文
- [ ] 所有Channel支持文本、图片、文件附件
- [ ] 富文本格式（Markdown）在各平台正确渲染或优雅降级

**优先级**：P1（扩展性基础）

---

### 2.2 多租户隔离

**需求描述**：系统必须支持多个用户/团队同时使用，彼此的Session、配置、数据完全隔离。

**业务价值**：
- **隐私保护**：团队A的对话对团队B不可见
- **资源公平**：单个用户的高负载不影响其他用户
- **合规性**：满足多租户数据隔离要求

**技术实现**：
- Session Key格式：`agent:{agentId}:{chatId}`
- 按Channel + User隔离状态
- Lane级别并发限制（Main Lane：8并发，每个User的请求FIFO排队）

**验收标准**：
- [ ] 用户A无法访问用户B的Session历史
- [ ] 用户A的长时间任务不阻塞用户B的快速查询
- [ ] 同一用户在不同Channel的Session完全隔离
- [ ] 支持至少100个并发用户（受硬件限制）

**优先级**：P0（基础架构）

---

## 3. 可观测性与控制

### 3.1 实时状态流

**需求描述**：用户/管理员能够实时查看Agent的思考过程、工具调用、中间结果。

**业务价值**：
- **透明性**：用户理解Agent正在做什么
- **调试**：开发者快速定位问题
- **信任**：可见的过程建立信任

**技术实现**：
- WebSocket Event Stream
- 事件类型：`agent.thinking`, `agent.tool_call`, `agent.delta`, `agent.result`
- Sequence Number机制防止消息乱序

**验收标准**：
- [ ] 用户在UI中看到Agent思考过程（Thinking Mode开启时）
- [ ] 所有工具调用显示输入参数和返回结果
- [ ] 流式输出每个token的延迟 < 100ms
- [ ] 客户端能检测并警告sequence gap（消息丢失）

**优先级**：P1（用户体验）

---

### 3.2 任务中止与恢复

**需求描述**：用户必须能够随时中止正在运行的Agent任务，且系统能够安全清理资源。

**业务价值**：
- **控制权**：用户始终是主导，不是被动等待
- **成本控制**：错误任务及时终止避免浪费API配额
- **安全性**：可疑行为立即阻止

**技术实现**：
- `AbortController`机制（每个runId一个）
- `chat.abort` RPC方法
- 优雅终止：通知Agent停止，清理临时资源，广播`aborted`事件

**验收标准**：
- [ ] 用户发送`/stop`后，Agent在1秒内停止新的API调用
- [ ] 已启动的LLM请求返回后不被处理
- [ ] 中止后的Session状态一致（不会部分写入）
- [ ] 中止事件在所有连接的客户端同步显示

**优先级**：P0（核心功能）

---

## 4. 设备协同（Node系统）

### 4.1 跨设备工具调用

**需求描述**：Agent能够调用连接到Gateway的物理设备（iPhone、Android、macOS）的能力（相机、位置、短信等）。

**业务价值**：
- **扩展能力边界**：Agent不局限于软件操作
- **物联网集成**：构建智能家居、安防等场景
- **移动优先**：利用手机传感器增强AI能力

**技术实现**：
- Node Registry（`src/gateway/node-registry.ts`）
- WebSocket RPC：Agent → Gateway → Node
- 平台特定命令白名单（macOS、iOS、Android）

**验收标准**：
- [ ] Agent能够通过`nodes.invoke`调用已配对iPhone的相机
- [ ] 未配对设备的调用请求被拒绝
- [ ] 网络中断时，调用超时并返回明确错误
- [ ] 同一命令的重复调用被幂等性机制过滤

**优先级**：P2（特色功能）

---

### 4.2 设备发现与配对

**需求描述**：新设备连接到Gateway时，必须经过用户显式批准才能被Agent调用。

**业务价值**：
- **安全性**：防止未授权设备接入
- **用户控制**：用户明确知道哪些设备已连接
- **审计**：配对记录可追溯

**技术实现**：
- mDNS/Bonjour自动发现
- `device.pair.requested`事件通知管理员
- Pairing Token持久化到`paired.json`

**验收标准**：
- [ ] 新设备连接后，管理员收到配对请求通知
- [ ] 未批准的设备无法调用任何工具
- [ ] 配对后的设备在重启后自动重连
- [ ] 管理员可以撤销已配对设备的权限

**优先级**：P1（安全基础）

---

## 5. 成本优化

### 5.1 混合模型策略

**需求描述**：系统必须支持对不同类型任务使用不同成本的模型（如主Agent用强模型，Subagent用弱模型）。

**业务价值**：
- **成本降低**：根据架构文档，可降低60-80% API成本
- **性能平衡**：核心任务不妥协质量，简单任务节省开销
- **可持续性**：长期运营成本可控

**技术实现**：
- `agents.defaults.subagent.model`配置
- 任务分类：核心推理（强模型） vs 子任务执行（弱模型）

**验收标准**：
- [ ] Subagent的LLM调用使用配置的弱模型
- [ ] 相比全强模型方案，总Token消耗减少 > 50%
- [ ] 弱模型任务成功率 > 80%（简单任务场景）
- [ ] 失败时自动failover到强模型

**优先级**：P1（运营关键）

---

### 5.2 Embedding缓存

**需求描述**：相同内容的Embedding只计算一次，后续查询直接从缓存读取。

**业务价值**：
- **成本节约**：减少90%+ Embedding API调用
- **性能提升**：缓存命中时延迟从秒级降到毫秒级
- **可持续性**：大规模RAG场景可行

**技术实现**：
- SQLite表`embedding_cache`
- Key: `(provider, model, content_hash)`
- 自动失效：文件内容变化导致hash变化

**验收标准**：
- [ ] 同一文件重复索引时，Embedding API调用次数 = 0
- [ ] 缓存命中率 > 90%（稳定运行后）
- [ ] 缓存数据库大小可控（定期清理陈旧条目）
- [ ] 文件修改后，旧Embedding自动失效

**优先级**：P1（成本优化）

---

## 6. 数据管理

### 6.1 Session导出与迁移

**需求描述**：用户能够导出Session数据为标准格式，并在不同实例间迁移。

**业务价值**：
- **数据主权**：用户完全拥有对话数据
- **备份恢复**：支持灾难恢复
- **多实例协同**：开发/生产环境数据同步

**技术实现**：
- JSON5文件格式（`~/.openclaw/sessions/`）
- 标准化Schema（`SessionEntry`）

**验收标准**：
- [ ] 用户可一键导出所有Session为ZIP包
- [ ] 导出的文件可导入到另一个PonyBunny实例
- [ ] 导入后，对话历史、工具调用记录完整
- [ ] 敏感信息（API Key）不包含在导出文件中

**优先级**：P2（数据自主性）

---

### 6.2 审计日志

**需求描述**：所有工具调用、权限验证、模型切换等关键操作必须记录到不可篡改的日志。

**业务价值**：
- **合规性**：满足SOC2、GDPR等审计要求
- **事后分析**：故障排查、安全事件调查
- **信任**：向用户证明系统行为

**技术实现**：
- 结构化日志（JSON Lines格式）
- 关键字段：timestamp, userId, action, resource, result, reason
- 日志轮转与压缩

**验收标准**：
- [ ] 所有工具调用在日志中有完整记录（输入、输出、耗时）
- [ ] 权限拒绝事件记录拒绝原因
- [ ] 日志文件支持外部审计工具解析（如Splunk、ELK）
- [ ] 日志保留期可配置（默认90天）

**优先级**：P1（企业必需）

---

## 7. 扩展性

### 7.1 自定义Tool注册

**需求描述**：开发者能够编写自定义Tool并动态注册到Agent Runtime。

**业务价值**：
- **灵活性**：满足特定业务需求
- **生态**：社区贡献工具形成生态系统
- **快速迭代**：无需修改核心代码

**技术实现**：
- Plugin系统（`extensions/`）
- Tool Schema定义（JSON Schema）
- 动态加载与热重载

**验收标准**：
- [ ] 开发者可在`extensions/my-tool/`编写工具并自动加载
- [ ] 自定义Tool支持完整的输入验证（JSON Schema）
- [ ] Tool故障不影响其他Tool或核心系统
- [ ] Tool调用统计与性能监控

**优先级**：P2（生态基础）

---

### 7.2 Webhook集成

**需求描述**：外部系统能够通过Webhook向PonyBunny发送事件，触发Agent执行。

**业务价值**：
- **自动化**：监控告警、CI/CD失败自动触发Agent分析
- **集成**：连接现有企业工具链（Jira、Confluence、GitHub）
- **主动服务**：Agent不仅响应用户，还能主动处理系统事件

**技术实现**：
- HTTP Webhook接收端点
- 事件路由到对应Session
- 签名验证（HMAC-SHA256）

**验收标准**：
- [ ] GitHub PR创建时，通过Webhook触发代码审查Agent
- [ ] 未签名的Webhook请求被拒绝
- [ ] Webhook事件在Session历史中正确记录
- [ ] 支持异步响应（长时间任务）

**优先级**：P2（企业集成）

---

## 功能优先级总结

| 优先级 | 功能模块 | 关键需求 |
|:------|:--------|:--------|
| **P0** | 核心Agent | 多模型Failover、长上下文、沙箱执行、多租户隔离、任务中止 |
| **P1** | 可观测性 | 实时状态流、审计日志、成本优化（缓存、混合模型）、设备配对 |
| **P2** | 扩展性 | Session导出、自定义Tool、Webhook集成、跨设备调用 |
