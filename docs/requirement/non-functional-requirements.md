# 非功能需求 (Non-Functional Requirements)

## 1. 性能 (Performance)

### 1.1 响应时间

**需求**：系统必须在可接受的时间内响应用户请求，即使在高负载情况下。

**具体指标**：
- **WebSocket连接建立**：< 500ms
- **Agent首Token响应**：< 2秒（P95，包含LLM API调用）
- **流式输出延迟**：每个Token < 100ms
- **工具调用往返时间**：
  - 本地工具（文件读取）：< 200ms
  - 远程Node调用（相机拍照）：< 3秒
- **Session查询**：< 100ms（1000条历史消息）

**验证方法**：
- 负载测试：使用k6/Locust模拟100并发用户
- 监控：Prometheus + Grafana跟踪P50/P95/P99延迟
- SLA定义：99%的请求满足上述指标

**优先级**：P0

---

### 1.2 吞吐量

**需求**：系统必须支持个人/小团队的日常使用负载。

**具体指标**：
- **并发Session**：单用户1-5个Session并行（Main + Subagent）
- **消息吞吐**：
  - 每秒处理10+条入站消息（个人多平台使用）
  - 每秒发送20+条出站消息（流式输出）
- **WebSocket连接**：单实例支持10+并发连接（个人多设备 + 小团队）
- **数据库操作**：SQLite WAL模式下，100+ QPS读操作

**扩展策略**：
- 单机优化：利用多核CPU（Lane并发机制）
- 小团队共享：2-5人共享同一实例

**优先级**：P1

---

### 1.3 资源效率

**需求**：系统必须能在个人电脑或廉价VPS上流畅运行。

**具体指标**：
- **内存占用**：
  - Gateway进程：< 512MB（空闲）
  - 单个Agent沙箱：< 256MB
  - 总内存峰值：< 2GB（个人使用）
- **CPU使用**：
  - 空闲时：< 5%（不干扰其他应用）
  - 高负载：< 50%（留给其他个人应用）
- **磁盘I/O**：
  - Session写入：批处理，< 10 IOPS
  - 日志轮转：自动压缩，磁盘增长 < 100MB/天（个人使用）

**优化手段**：
- Embedding缓存减少重复计算
- Session Compaction控制历史文件大小
- Docker镜像分层缓存，加速启动

**优先级**：P1

---

## 2. 可靠性 (Reliability)

### 2.1 可用性

**需求**：系统必须可靠运行，个人用户无需频繁重启。

**具体指标**：
- **目标可用性**：99%（月停机时间 < 7.2小时，适合个人运维）
- **单点故障容忍**：
  - LLM Provider故障：自动failover到备用模型，< 5秒切换时间
  - SQLite锁竞争：WAL模式，读不阻塞写
  - Channel断连：自动重连，指数退避策略
- **优雅降级**：
  - Memory检索失败 → 仅使用Session History
  - Embedding API超时 → 使用纯关键字搜索

**故障检测**：
- 健康检查端点：`/health`（每5秒探测）
- 自动重启策略：Docker `restart: unless-stopped`
- 告警规则：连续3次健康检查失败触发通知

**优先级**：P0

---

### 2.2 数据完整性

**需求**：系统崩溃/断电时，不能丢失或损坏用户数据。

**具体指标**：
- **Session持久化**：每条消息写入后立即fsync（可配置）
- **SQLite ACID**：启用WAL + `synchronous=NORMAL`
- **工具调用幂等性**：相同`idempotencyKey`只执行一次

**备份策略**：
- 自动备份：每日增量备份Session文件
- Point-in-time Recovery：基于SQLite Checkpoint
- 验证机制：定期校验数据库完整性（`PRAGMA integrity_check`）

**灾难恢复**：
- RTO（恢复时间目标）：< 1小时
- RPO（恢复点目标）：< 15分钟（最近一次自动备份）

**优先级**：P0

---

### 2.3 故障隔离

**需求**：单个组件故障不应导致整体系统崩溃。

**隔离策略**：
- **Lane隔离**：Cron任务阻塞不影响Main Lane
- **沙箱隔离**：Agent代码crash仅影响该任务，不影响Gateway
- **Channel隔离**：WhatsApp故障不影响Telegram
- **User隔离**：单个用户的恶意请求不影响其他用户

**熔断机制**：
- LLM API连续失败5次 → 暂停该Provider 30秒
- 单个Tool连续失败3次 → 禁用该Tool，记录告警

**优先级**：P1

---

## 3. 可扩展性 (Scalability)

### 3.1 单机部署优化

**需求**：系统必须能在单机环境高效运行，无需复杂分布式架构。

**架构支持**：
- **单机存储**：SQLite足以支持个人/小团队使用
- **本地文件系统**：Session存储在`~/.openclaw/sessions/`
- **无外部依赖**：不需要Redis、PostgreSQL等外部服务

**扩展策略**：
- 小团队（2-5人）：共享单个Gateway实例
- 资源不足时：升级单机硬件（垂直扩展）

**当前限制**：
- SQLite并发写限制（适合个人/小团队，非大型团队）
- 单机故障无自动切换（适合个人容忍度）

**优先级**：P0（个人部署核心）

---

### 3.2 配置灵活性

**需求**：系统行为可通过配置调整，无需修改代码。

**可配置项**：
- **模型配置**：主模型、fallback链、thinking level
- **并发控制**：Main/Subagent/Cron Lane的`maxConcurrent`
- **资源限制**：Docker容器内存、CPU、PID限制
- **安全策略**：工具白名单、Pairing模式（自动/手动）
- **性能调优**：Compaction阈值、缓存大小

**配置热更新**：
- `config.apply` RPC支持动态更新（部分参数）
- 无需重启即可调整并发限制
- 敏感配置（API Key）需要重启生效

**优先级**：P1

---

## 4. 安全性 (Security)

### 4.1 认证与授权

**需求**：所有访问必须经过身份验证和权限检查。

**认证机制**：
- **WebSocket客户端**：Token-based（JWT或opaque token）
- **Node设备**：Ed25519签名 + Pairing Token
- **Webhook**：HMAC-SHA256签名验证

**授权模型**：
- **工具调用**：白名单 + 平台限制（macOS/iOS/Android）
- **Session访问**：用户只能访问自己的Session
- **管理操作**：需要`admin`角色（如配对设备、查看系统日志）

**密钥管理**：
- API Key加密存储（AES-256-GCM）
- 密钥轮转：支持多个Auth Profile无缝切换
- 敏感数据不记录到日志

**优先级**：P0

---

### 4.2 数据隔离

**需求**：多租户环境下，用户数据完全隔离。

**隔离层级**：
- **Session层**：不同用户的Session文件分离
- **数据库层**：Vector Search结果过滤（添加`userId`字段）
- **日志层**：审计日志包含用户标识，支持按用户过滤

**防护措施**：
- SQL注入防护：使用参数化查询
- 路径遍历防护：文件路径验证（禁止`../`）
- 跨Session攻击：严格的`sessionId`验证

**优先级**：P0

---

### 4.3 沙箱安全

**需求**：Agent执行的代码不能逃逸沙箱或访问未授权资源。

**Docker沙箱配置**：
- **只读根文件系统**：`readOnlyRoot: true`
- **能力限制**：`capDrop: ALL`
- **Seccomp过滤**：限制系统调用
- **资源限制**：内存256MB、PID 100、CPU 0.5核

**逃逸防护**：
- 禁用特权模式：`--privileged=false`
- 禁止挂载敏感目录：`/etc`, `/sys`, `/proc`（只读或不挂载）
- 网络隔离：默认无外网访问（除非显式配置）

**定期扫描**：
- Docker镜像漏洞扫描（Trivy/Clair）
- 依赖安全审计（`npm audit`）

**优先级**：P0

---

## 5. 可维护性 (Maintainability)

### 5.1 日志与监控

**需求**：系统行为可观测，问题可快速定位。

**日志级别**：
- **ERROR**：需要立即处理的错误
- **WARN**：潜在问题（如模型fallback）
- **INFO**：关键操作（Agent启动、工具调用）
- **DEBUG**：详细调试信息（仅开发环境）

**日志格式**：
- 结构化JSON Lines
- 必需字段：`timestamp`, `level`, `component`, `message`, `context`

**监控指标**：
- **系统指标**：CPU、内存、磁盘、网络
- **业务指标**：每分钟请求数、Agent成功率、平均Token消耗
- **SLA指标**：P95延迟、可用性百分比

**可视化**：
- Grafana仪表盘（实时指标）
- Kibana日志查询（历史分析）

**优先级**：P1

---

### 5.2 可调试性

**需求**：开发者能够快速重现和修复问题。

**调试工具**：
- **Replay功能**：根据Session历史重放Agent执行
- **断点模式**：Agent执行前暂停，等待人工确认
- **工具调用Mock**：测试环境替换真实工具为Mock

**错误上下文**：
- 错误消息包含完整调用栈
- Session ID、Run ID在所有日志中可追踪
- LLM API请求/响应完整记录（开启DEBUG时）

**优先级**：P2

---

### 5.3 文档完整性

**需求**：所有功能有清晰的文档，降低学习成本。

**文档类型**：
- **用户手册**：安装、配置、使用指南
- **API文档**：WebSocket协议、RPC方法
- **架构文档**：系统设计、技术决策（当前已有）
- **开发者指南**：如何贡献代码、编写插件

**文档质量标准**：
- 每个RPC方法有完整的参数说明和示例
- 每个配置项有默认值和可选范围
- 常见问题有FAQ或Troubleshooting指南

**优先级**：P2

---

## 6. 可用性 (Usability)

### 6.1 易部署

**需求**：个人用户能够在15分钟内完成从零到运行的完整部署。

**部署方式**：
- **Docker一键部署**（推荐）：
  ```bash
  docker run -d -p 18789:18789 -v pony-data:/data ponybunny/gateway
  ```
- **Docker Compose**（完整配置）：
  ```bash
  curl -O https://ponybunny.io/docker-compose.yml
  docker-compose up -d
  ```
- **本地开发**：
  ```bash
  git clone https://github.com/ponybunny/gateway
  pnpm install && pnpm dev
  ```

**首次配置**：
- 向导式设置（CLI交互式）
- 自动检测并提示缺失的API Key
- 预设配置模板（个人开发者、自由职业者、隐私模式）

**优先级**：P0（个人用户核心）

---

### 6.2 易用性

**需求**：非技术背景的个人用户也能完成基本配置和使用。

**用户界面**：
- **Web UI**：现代化React界面（响应式，支持手机浏览器）
- **CLI**：交互式命令行工具（可选，面向开发者）
- **消息平台**：通过Telegram/WhatsApp直接交互（主要方式）

**帮助系统**：
- 内置`/help`命令
- 配置向导（首次启动自动引导）
- 示例对话模板（"如何让Agent帮我审查代码？"）
- 视频教程（YouTube，5-10分钟）

**优先级**：P1（个人用户体验）

---

### 6.3 国际化

**需求**：支持多语言界面和错误提示。

**支持语言**：
- 英语（默认）
- 中文（简体/繁体）
- 日语、韩语、西班牙语（未来）

**实现**：
- i18n库（react-i18next）
- 错误消息多语言映射
- Agent响应语言跟随用户输入（自动检测）

**优先级**：P3（国际化扩展）

---

## 7. 兼容性 (Compatibility)

### 7.1 平台兼容性

**需求**：系统必须在主流操作系统和架构上运行。

**支持平台**：
- **Linux**：Ubuntu 20.04+, Debian 11+, CentOS 8+（主要）
- **macOS**：macOS 12+ (Intel/Apple Silicon)
- **Windows**：通过WSL2或Docker Desktop

**架构支持**：
- **x86_64**：完全支持
- **ARM64**：完全支持（Apple Silicon、AWS Graviton）

**优先级**：P0（Linux/macOS），P2（Windows）

---

### 7.2 浏览器兼容性

**需求**：Web UI在主流浏览器中正常工作。

**支持浏览器**：
- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

**Polyfill策略**：
- 使用Vite自动注入必要的Polyfill
- WebSocket回退到长轮询（极端情况）

**优先级**：P1

---

### 7.3 LLM Provider兼容性

**需求**：系统必须适配不同Provider的协议差异。

**已支持Provider**：
- OpenAI（GPT系列）
- Anthropic（Claude系列）
- Google（Gemini系列）
- 本地模型（Ollama、LM Studio）

**适配机制**：
- Turn Validation（Gemini、Anthropic的消息格式要求）
- 参数映射（统一`thinkingLevel`到各Provider的参数）
- 错误码标准化

**优先级**：P0

---

## 8. 合规性 (Compliance)

### 8.1 数据隐私

**需求**：满足个人用户的隐私保护需求，数据100%本地化。

**隐私措施**：
- **本地存储**：所有数据存储在`~/.openclaw/`，不上传到任何服务器
- **用户控制**：用户可随时导出/删除所有数据
- **数据加密**：敏感字段（API Key）加密存储
- **透明性**：明确告知哪些数据会调用外部API（仅LLM推理）

**数据处理原则**：
- 不收集用户对话数据用于改进模型
- LLM API调用符合各Provider的ToS（用户自行承担）
- 日志本地存储，支持脱敏（自动隐藏敏感字段）

**优先级**：P0（个人用户核心）

---

### 8.2 安全标准

**需求**：满足企业安全审计要求。

**参考标准**：
- **SOC 2 Type II**（未来认证目标）
- **OWASP Top 10**：防护常见Web漏洞
- **CIS Docker Benchmark**：Docker安全配置

**安全实践**：
- 依赖定期更新（Dependabot）
- 静态代码分析（SonarQube/CodeQL）
- 渗透测试（年度）

**优先级**：P2（企业增强）

---

## 非功能需求优先级总结

| 类别 | P0（核心） | P1（重要） | P2（增强） | P3（未来） |
|:-----|:----------|:----------|:----------|:----------|
| **性能** | 响应时间 | 吞吐量、资源效率 | - | - |
| **可靠性** | 可用性、数据完整性 | 故障隔离 | - | - |
| **可扩展性** | - | 配置灵活性 | 水平扩展 | - |
| **安全性** | 认证、数据隔离、沙箱 | - | - | - |
| **可维护性** | - | 日志监控、易部署 | 调试、文档 | - |
| **可用性** | - | 易部署、浏览器兼容 | 易用性 | 国际化 |
| **兼容性** | 平台（Linux/macOS）、LLM Provider | 浏览器 | 平台（Windows） | - |
| **合规性** | - | 数据隐私 | 安全标准 | - |
